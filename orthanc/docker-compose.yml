# ═══════════════════════════════════════════════════════════════════════════════
# ORTHANC PACS - Docker Compose Configuration
# ═══════════════════════════════════════════════════════════════════════════════
#
# PORT SCHEME (9010 series for Orthanc):
#   - orthanc      : PACS Server + API (port 9011, DICOM 4242)
#   - ohif         : DICOM Viewer (port 9012)
#   - orthanc-db   : PostgreSQL Database (port 9013)
#
# UI components are in the monitoring stack:
#   - workflow-ui  : Workflow Dashboard (port 9030)
#
# NOTE: Workflow tracking moved to monitoring stack (workflow-api on port 9031)
#       Grafana moved to monitoring stack (port 9032) for unified dashboards
#
# Quick start:
#   cp config/env.template .env
#   # Edit .env to set your POSTGRES_PASSWORD
#   docker compose up -d
#
# ═══════════════════════════════════════════════════════════════════════════════

services:
  # ─────────────────────────────────────────────────────────────────────────────
  # ORTHANC - PACS Server
  # ─────────────────────────────────────────────────────────────────────────────
  orthanc:
    image: jodogne/orthanc-python
    container_name: orthanc-server
    command: /run/secrets/
    secrets:
      - orthanc.json
    ports:
      - "${ORTHANC_WEB_PORT:-9011}:8042"
      - "${DICOM_PORT:-4242}:4242"
    volumes:
      # Mount Lua scripts (v2 - modular)
      - ./lua-scripts-v2:/etc/orthanc/lua-v2:ro
      # Keep old scripts available for rollback
      - ./lua-scripts:/etc/orthanc/lua:ro
      - orthanc-storage:/var/lib/orthanc/db
    env_file: ./.env
    environment:
      - ORTHANC_NAME=${ORTHANC_AET:-ORTHANC_LPCH}
      - TZ=${TZ:-America/Los_Angeles}
      # Lua scripts use this to call the workflow-api
      - WORKFLOW_API_URL=${WORKFLOW_API_URL}
    depends_on:
      orthanc-db:
        condition: service_healthy
    # NOTE: Orthanc Lua scripts call the monitoring stack's workflow-api
    # Uses WORKFLOW_API_URL from config.env (set via setup-config.sh)
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8042/system > /dev/null || exit 1"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 60s

  # ─────────────────────────────────────────────────────────────────────────────
  # OHIF VIEWER - Clinical image viewing
  # ─────────────────────────────────────────────────────────────────────────────
  ohif:
    image: mercureimaging/ohif
    container_name: orthanc-ohif
    ports:
      - "${OHIF_PORT:-9012}:80"
    volumes:
      - ./config/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    environment:
      - TZ=${TZ:-America/Los_Angeles}
    depends_on:
      - orthanc
    restart: always
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ─────────────────────────────────────────────────────────────────────────────
  # POSTGRESQL - Database for Orthanc index and routing state
  # ─────────────────────────────────────────────────────────────────────────────
  orthanc-db:
    image: postgres:15
    container_name: orthanc-postgres
    ports:
      - "${POSTGRES_PORT:-9013}:5432"
    environment:
      - POSTGRES_DB=orthanc
      - POSTGRES_USER=${POSTGRES_USER:-orthanc}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-ChangeThisPassword}
      - TZ=${TZ:-America/Los_Angeles}
    volumes:
      - orthanc-db-data:/var/lib/postgresql/data
      - ./init:/docker-entrypoint-initdb.d:ro
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-orthanc} -d orthanc"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

# ═══════════════════════════════════════════════════════════════════════════════
# SECRETS
# ═══════════════════════════════════════════════════════════════════════════════
secrets:
  orthanc.json:
    file: ./config/orthanc.json

# ═══════════════════════════════════════════════════════════════════════════════
# NETWORKS
# ═══════════════════════════════════════════════════════════════════════════════
networks:
  default:
    driver: bridge
  # NOTE: Mercure connection is via host network (MERCURE_DB_HOST in .env)
  # No external network dependency - Orthanc works standalone

# ═══════════════════════════════════════════════════════════════════════════════
# VOLUMES
# ═══════════════════════════════════════════════════════════════════════════════
# Storage paths are configured via .env file
# Default: /opt/orthanc/orthanc-storage and /opt/orthanc/postgres-data
# ═══════════════════════════════════════════════════════════════════════════════
volumes:
  orthanc-storage:
    driver: local
    driver_opts:
      type: 'none'
      o: 'bind'
      device: '${DICOM_STORAGE:-/opt/orthanc/orthanc-storage}'
  
  orthanc-db-data:
    driver: local
    driver_opts:
      type: 'none'
      o: 'bind'
      device: '${POSTGRES_STORAGE:-/opt/orthanc/postgres-data}'
