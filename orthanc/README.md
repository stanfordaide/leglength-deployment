# Orthanc PACS

DICOM server with Lua-based routing logic, study tracking, and integration with the AI pipeline.

## Ports

| Port | Service | Purpose |
|------|---------|---------|
| **9011** | Orthanc Web/API | PACS UI & REST API |
| **9012** | OHIF Viewer | Clinical image viewer |
| **9013** | PostgreSQL | Database |
| **9010** | Dashboard | Operator control (deprecated) |
| **4242** | DICOM | DICOM protocol |

## Quick Start

Configuration is generated by parent `make setup` from `config.env.template`.

```bash
# Configuration is auto-generated by parent Makefile
# Edit in parent directory:
cd ..
vim config.env.template
sudo make setup
cd orthanc

# Start Orthanc
sudo docker compose up -d

# Access
# - Orthanc Web: http://localhost:9011
# - OHIF Viewer: http://localhost:9012
```

## Architecture

```
┌──────────────────────────────┐
│  DICOM Devices (4242)        │
│  ├─ Modality devices         │
│  ├─ Workstations             │
│  └─ AI module (Mercure)      │
└──────────────┬───────────────┘
               │
               ▼
┌──────────────────────────────┐
│  Orthanc PACS                │
│  ├─ Study Storage            │
│  ├─ Lua Routing Scripts      │
│  ├─ Web UI (9011)            │
│  └─ REST API (9011)          │
└──────────────┬───────────────┘
               │
       ┌───────┴───────┐
       │               │
       ▼               ▼
PostgreSQL      Lua Scripts
(9013)          (routing logic)
```

## Configuration

All settings come from parent `config.env.template`. Key variables:

```bash
ORTHANC_WEB_PORT=9011
ORTHANC_ADMIN_USER=orthanc_admin
ORTHANC_ADMIN_PASS=...
ORTHANC_DB_PORT=9013

# Modalities (DICOM destinations)
MODALITY_MERCURE=MERCURE|172.17.0.1|11112
MODALITY_LPCHROUTER=LPCHROUTER|10.50.133.21|4000
MODALITY_LPCHTROUTER=LPCHTROUTER|10.50.130.114|4000
MODALITY_MODLINK=PSRTBONEAPP01|10.251.201.59|104
```

To update configuration:

```bash
# Edit parent config
cd ..
vim config.env.template
sudo make setup
cd orthanc

# Restart Orthanc to pick up changes
sudo docker compose restart orthanc
```

## Managing DICOM Destinations (Modalities)

### Add/Edit in Web UI (Recommended)

1. Open Orthanc: http://localhost:9011
2. Admin → Modalities
3. Add or edit as needed
4. Changes take effect immediately

### Add via API

```bash
curl -X PUT http://localhost:9011/modalities/NEWPACS \
  -u orthanc_admin:YOUR_PASSWORD \
  -H "Content-Type: application/json" \
  -d '{
    "AET": "NEWPACS",
    "Host": "192.168.1.100",
    "Port": 4242,
    "AllowEcho": true,
    "AllowStore": true
  }'
```

### Test Destination Connectivity

```bash
# Via Orthanc UI
# Admin → Modalities → [Select] → Echo

# Via API
curl -X POST http://localhost:9011/modalities/MERCURE/echo \
  -u orthanc_admin:YOUR_PASSWORD
```

## Routing Logic (Lua Scripts)

Lua scripts in `lua-scripts-v2/` analyze incoming studies and:

1. Check if AI processing needed
2. Route to Mercure if required
3. Send results to destinations (LPCH, MODLINK, etc.)

Key variables (passed by parent make setup):

```lua
WORKFLOW_API_URL = "http://172.17.0.1:9031"  -- Monitoring API
DOCKER_HOST_GATEWAY = "172.17.0.1"            -- Container → Host
```

Script: `lua-scripts-v2/config.lua` - Edit to customize routing patterns

## Commands

```bash
# Status
sudo docker compose ps
sudo docker compose logs orthanc

# Restart
sudo docker compose restart orthanc

# Full restart (fresh)
sudo docker compose down && sudo docker compose up -d
```

## Troubleshooting

### Orthanc not starting

```bash
# Check logs
sudo docker compose logs orthanc

# Common issues:
# - Port 9011 in use: lsof -i :9011
# - Storage permission issue: sudo chown 1000:1000 /path/to/storage
# - Database not ready: Wait 30s and retry
```

### Studies not routing to Mercure

1. Check Lua logs in Orthanc UI → Admin → Logs
2. Verify Mercure is accessible: `curl http://172.17.0.1:11112`
3. Check `lua-scripts-v2/config.lua` routing patterns

### API authentication error

```bash
# Verify credentials in config
sudo docker compose exec orthanc cat /etc/orthanc/orthanc.json | grep -A2 "Username"

# Reset if needed (edit parent config.env.template)
cd ..
sudo make setup
cd orthanc && sudo docker compose restart orthanc
```

### Database connection refused

```bash
# Database might still be starting
sudo docker compose logs orthanc-db

# Wait for "database system is ready to accept connections"
sudo docker compose restart orthanc
```

## Integration Points

### Receives Studies From

- DICOM devices on port 4242
- Remote PACS systems (C-STORE)
- Manual uploads via Web UI

### Sends Studies To

- Mercure (for AI processing) - via Lua script
- DICOM destinations (LPCH, MODLINK, etc.)
- Monitoring API - for workflow tracking

### Called By

- Monitoring Workflow API - to check study status
- OHIF Viewer - to retrieve images

## Directory Structure

```
orthanc/
├── docker-compose.yml      # Service definition
├── README.md              # This file
├── Makefile               # Local convenience commands
│
├── config/
│   └── orthanc.json.template      # Orthanc settings (template)
│
├── lua-scripts-v2/
│   ├── config.lua         # Routing patterns & logic
│   ├── track.lua          # Track workflow events
│   └── *.lua              # Helper scripts
│
├── init/
│   └── *.sql              # Database initialization
│
└── scripts/
    └── (utilities)
```

## File Locations (Server /opt)

```
/opt/projects/leglength-deployment/orthanc/
├── .env                   # Generated from setup-config.sh
├── docker-compose.yml
├── config/
│   └── orthanc.json      # Generated from template + .env
└── lua-scripts-v2/
```

DICOM storage (from config.env):
```
/home/orthanc/orthanc-storage/
/home/orthanc/orthanc-db/
```

## Related

- **Parent:** [leglength-deployment/](../)
- **Workflow Guide:** [../CHANGES.md](../CHANGES.md)
- **Monitoring:** [../monitoring/](../monitoring/)
- **Mercure (AI):** [../mercure/](../mercure/)
- **Orthanc Docs:** https://orthanc.uclouvain.be/

## License

Internal use only - Stanford AIDE Lab
