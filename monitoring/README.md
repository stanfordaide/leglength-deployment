# Monitoring Stack

Workflow tracking, dashboards, and analytics for the pediatric leg length AI pipeline.

## Components

| Service | Port | Purpose |
|---------|------|---------|
| **workflow-ui** | 9030 | Study tracking dashboard (Vue.js) |
| **workflow-api** | 9031 | Workflow tracking API (Flask) |
| **grafana** | 9032 | Infrastructure dashboards & alerts |
| **prometheus** | 9033 | Metrics collection |
| **alertmanager** | 9034 | Alert routing |
| **node-exporter** | 9035 | Host system metrics |
| **cadvisor** | 9036 | Docker container metrics |
| **pushgateway** | 9037 | Prometheus push metrics |
| **graphite** | 9038 | Mercure metrics receiver |

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│  Workflow UI (9030)                                             │
│  ├─ Recent Studies                                              │
│  ├─ Pipeline Status: MERCURE → AI → DESTINATIONS                │
│  ├─ DICOM Destinations & Routes                                 │
│  └─ Metrics & Health                                            │
└──────────────────────┬──────────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────────┐
│ Workflow API (9031) - Flask Backend                             │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Job Poller (Background Thread)                          │   │
│  │ ├─ Every 10s: queries pending_jobs table                │   │
│  │ ├─ Calls Orthanc /jobs/{jobId} REST endpoint            │   │
│  │ ├─ Updates workflow_status with REAL result             │   │
│  │ └─ Removes completed jobs from pending_jobs             │   │
│  └─┬───────────────────────────────────────────────────────┘   │
│    │                                                             │
│  ┌─┴────────────────────────────────────────────────────────┐   │
│  │ Core Components                                          │   │
│  ├─ Study tracking (workflow_db)                            │   │
│  ├─ Mercure Bookkeeper integration (read-only analytics)    │   │
│  ├─ Orthanc API calls for status                            │   │
│  └─ Event endpoints: /track/{start,destination,ai-results}  │   │
│                                                                 │
└──────┬────────────────────┬────────────────────┬────────────────┘
       │                    │                    │
       ▼                    ▼                    ▼
    Orthanc             Mercure            PostgreSQL
    (9011)              (9020)              (workflow_db)
    └─ /jobs/{id}                          └─ pending_jobs
                                           └─ study_workflows
```

**Key Feature: Async Job Completion Tracking**
- When Orthanc sends to a destination, it returns a job ID
- Workflow API registers the job ID in `pending_jobs` table
- Background poller periodically checks if the job completed (success/failure)
- Only marks destination as "complete" when Orthanc confirms actual delivery
- See [CHANGES.md](../CHANGES.md#how-job-tracking-works-for-destination-sends) for details

## Quick Start

### 1. Configuration

Configuration is generated by parent `make setup` from `config.env.template`.

To manually regenerate:
```bash
cd ..
sudo make setup
cd monitoring
```

### 2. Start Services

```bash
# All monitoring services
sudo docker compose up -d

# Specific service
sudo docker compose up -d workflow-ui
```

### 3. Access

- **Workflow UI:** http://localhost:9030
- **Grafana:** http://localhost:9032 (admin/admin by default)
- **Prometheus:** http://localhost:9033

## Key Features

### Workflow UI

- Real-time study tracking
- Pipeline status: MERCURE → AI → DESTINATIONS
- Recent studies table with inline pipeline chips
- Destination management (add/test/edit)
- OHIF Viewer integration

### Workflow API Endpoints

```bash
# Get all recent workflows
curl http://localhost:9031/workflows

# Get funnel analytics (last 24h)
curl http://localhost:9031/funnel?hours=24

# Get pipeline trends
curl http://localhost:9031/funnel/timeseries?hours=24&interval=hour

# Recover lost workflow data from Mercure
curl -X POST http://localhost:9031/workflows/sync

# Mercure AI processing details
curl http://localhost:9031/mercure/study/{study_uid}
```

### Environment Variables (from parent config.env)

```bash
ORTHANC_WEB_PORT=9011
ORTHANC_API_URL=http://172.17.0.1:9011          # Container → Host
ORTHANC_USERNAME=orthanc_admin
ORTHANC_PASSWORD=...

BOOKKEEPER_DB_HOST=172.17.0.1                   # Mercure Bookkeeper
BOOKKEEPER_DB_PORT=9022
BOOKKEEPER_DB_NAME=mercure
BOOKKEEPER_DB_USER=mercure
BOOKKEEPER_DB_PASS=...

MONITORING_API_PORT=9031
MONITORING_UI_PORT=9030
```

## Data Persistence

- **workflow_db** PostgreSQL: `volumes/postgres-monitoring`
  - Stores study tracking state
  - NOT cleared on restart
  
- **Metrics** Prometheus: `volumes/prometheus-monitoring`
  - Time-series metrics (30-day retention)

## Making Changes

### Update the UI

```bash
# Edit monitoring/ui/index.html
vim ui/index.html

# Restart UI container
sudo docker compose restart workflow-ui

# Verify
curl http://localhost:9030
```

### Update the API

```bash
# Edit monitoring/api/app.py
vim api/app.py

# Rebuild image (if needed)
sudo docker build -f api/Dockerfile -t workflow-api:latest api/

# Restart
sudo docker compose restart workflow-api

# Check logs
sudo docker compose logs workflow-api
```

### Update Configuration

```bash
# Edit parent config.env.template
cd ..
vim config.env.template

# Regenerate all configs
sudo make setup

# Restart monitoring services
cd monitoring
sudo docker compose restart workflow-api
```

## Troubleshooting

### UI Shows "API Connection Failed"

```bash
# Check workflow-api is running
sudo docker compose ps workflow-api

# Test API connection
curl http://localhost:9031/workflows

# View logs
sudo docker compose logs workflow-api
```

### Studies Not Showing in UI

```bash
# Check Orthanc connectivity
sudo docker exec workflow-api curl http://172.17.0.1:9011/studies

# Recover from Mercure if reset
curl -X POST http://localhost:9031/workflows/sync

# Check workflow database
sudo docker exec monitoring_postgres_1 psql -U workflow_user -d workflow_db -c "SELECT COUNT(*) FROM study_workflows;"
```

### Slow Dashboard

```bash
# Reduce data retention (Prometheus)
vim config/prometheus/prometheus.yml
# Change: retention: 15d

# Restart Prometheus
sudo docker compose restart prometheus
```

## Directory Structure

```
monitoring/
├── docker-compose.yml          # Service definitions
├── README.md                   # This file
├── Makefile                    # Local commands
├── api/
│   ├── Dockerfile
│   ├── app.py                  # Flask workflow API
│   └── requirements.txt
├── ui/
│   ├── index.html              # Workflow dashboard
│   ├── config.js               # Fallback config
│   └── config-generated.js     # Generated from setup-config.sh
├── config/
│   ├── nginx/
│   │   └── default.conf        # UI proxy & API routing
│   ├── prometheus/
│   │   ├── prometheus.yml
│   │   └── alert_rules.yml
│   ├── alertmanager/
│   │   └── alertmanager.yml
│   └── grafana/
│       ├── provisioning/
│       │   ├── datasources/
│       │   └── dashboards/
│       └── dashboards/
└── scripts/
    └── (utilities)
```

## Related

- **Parent:** [leglength-deployment/](../)
- **Workflow Guide:** [../CHANGES.md](../CHANGES.md)
- **Orthanc Integration:** [../orthanc/](../orthanc/)
- **Mercure Integration:** [../mercure/](../mercure/)

## License

Internal use only - Stanford AIDE Lab
