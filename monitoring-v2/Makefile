# Monitoring - Makefile
# Metrics collection and visualization

.PHONY: help setup start stop restart logs status clean build clear

# Default target
help:
	@echo "Monitoring - Metrics Collection Stack"
	@echo ""
	@echo "Usage: make [target]"
	@echo ""
	@echo "Targets:"
	@echo "  setup      - Initial setup (create .env, directories)"
	@echo "  start      - Start all services"
	@echo "  stop       - Stop all services"
	@echo "  restart    - Restart all services"
	@echo "  logs       - Show logs (use LOGS_SERVICE=name for specific service)"
	@echo "  status     - Show service status"
	@echo "  build      - Build/rebuild containers (if needed)"
	@echo "  clean      - Remove containers and volumes (DANGER!)"
	@echo "  clear      - Remove all data for fresh start (requires stop first)"
	@echo ""
	@echo "Examples:"
	@echo "  make start"
	@echo "  make logs LOGS_SERVICE=grafana"
	@echo "  make restart"

# Setup: create directories (env is generated by setup-config.sh)
setup:
	@echo "=== Setting up Monitoring ==="
	@if [ ! -f .env ]; then \
		echo "WARNING: .env not found!"; \
		echo "Run 'make setup' from project root to generate .env from config.env.template"; \
		echo "Or copy env.template to .env manually"; \
		exit 1; \
	fi
	@mkdir -p data/{prometheus,grafana,graphite}
	@mkdir -p config/{prometheus,grafana/{provisioning/{datasources,dashboards},dashboards}}
	@echo ""
	@echo "Setup complete! .env file found."
	@echo "Run 'make start' to start services"

# Start services
start:
	@if [ ! -f "config/prometheus/prometheus.yml" ]; then \
		echo "ERROR: prometheus.yml not found!"; \
		echo "Run 'make setup' from project root to generate configs."; \
		exit 1; \
	fi
	@echo "Starting Monitoring services..."
	docker compose up -d
	@echo ""
	@echo "Services starting. Access:"
	@echo "  Grafana:     http://localhost:$${GRAFANA_PORT:-9032}"
	@echo "  Prometheus:  http://localhost:$${PROMETHEUS_PORT:-9033}"
	@echo "  Graphite:    http://localhost:$${GRAPHITE_WEB_PORT:-9041}"

# Stop services
stop:
	@echo "Stopping services..."
	docker compose down

# Restart services
restart: stop start

# Show logs
LOGS_SERVICE ?= 
logs:
ifdef LOGS_SERVICE
	docker compose logs -f $(LOGS_SERVICE)
else
	docker compose logs -f
endif

# Show status
status:
	@echo "=== Service Status ==="
	@docker compose ps
	@echo ""
	@echo "=== Health Checks ==="
	@echo "Prometheus:   $$(curl -s http://localhost:$${PROMETHEUS_PORT:-9033}/-/healthy 2>/dev/null || echo 'unreachable')"
	@echo "Grafana:      $$(curl -s http://localhost:$${GRAFANA_PORT:-9032}/api/health 2>/dev/null | head -c 50 || echo 'unreachable')"
	@echo "Graphite:     $$(nc -z localhost $${GRAPHITE_PORT:-9038} 2>/dev/null && echo 'OK' || echo 'unreachable')"

# Build containers (mostly for future custom images)
build:
	@echo "Building containers..."
	docker compose build

# Clean everything (DANGER!)
clean:
	@echo "WARNING: This will remove all containers and volumes!"
	@read -p "Are you sure? [y/N] " confirm && [ "$$confirm" = "y" ] || exit 1
	docker compose down -v
	@echo "Cleaned."

# Clear: Remove all data for fresh start (requires services to be stopped)
clear:
	@echo "=== Clearing Monitoring Data ==="
	@echo ""
	@echo "Checking if services are stopped..."
	@if docker compose ps 2>/dev/null | grep -q "Up"; then \
		echo "âŒ ERROR: Services are still running!"; \
		echo "   Please run 'make stop' or 'make monitoring-stop' first."; \
		exit 1; \
	fi
	@echo "âœ… Services are stopped"
	@echo ""
	@echo "âš ï¸  This will permanently delete:"
	@echo "   - All Docker volumes (prometheus_data, graphite_data, grafana_data)"
	@echo "   - All data directories"
	@echo ""
	@read -p "Continue? Type 'yes' to confirm: " confirm && [ "$$confirm" = "yes" ] || exit 1
	@echo ""
	@echo "ðŸ—‘ï¸  Removing containers and volumes..."
	@docker compose down -v --remove-orphans 2>/dev/null || true
	@echo "ðŸ—‘ï¸  Removing data directories..."
	@rm -rf data/ 2>/dev/null || true
	@echo "ðŸ—‘ï¸  Removing generated prometheus.yml (will be regenerated by make setup)..."
	@rm -rf config/prometheus/prometheus.yml 2>/dev/null || true
	@echo ""
	@echo "âœ… Clear complete! All monitoring data removed."
	@echo ""
	@echo "Next steps:"
	@echo "  1. Run 'make setup' from project root to regenerate configs"
	@echo "  2. Run 'make monitoring-start' to start fresh"

# Quick commands
ps:
	docker compose ps

up: start
down: stop

# Reset: Clean restart
reset:
	@echo "=== Resetting Monitoring ==="
	@echo "1. Stopping monitoring if running..."
	@docker compose down 2>/dev/null || echo "  Monitoring not running"
	@echo "2. Ensuring .env exists (from config.env.template)..."
	@if [ ! -f .env ]; then \
		echo "  ERROR: .env not found!"; \
		echo "  Run 'make setup' from project root first to generate .env"; \
		exit 1; \
	fi
	@echo "3. Creating data directories..."
	@mkdir -p data/{prometheus,grafana,graphite}
	@mkdir -p config/{prometheus,grafana/{provisioning/{datasources,dashboards},dashboards}}
	@echo "4. Starting monitoring..."
	@make start
	@echo ""
	@echo "âœ… Reset complete! Monitoring is running."
	@echo "   Grafana: http://localhost:$${GRAFANA_PORT:-9032}"
	@echo "   Prometheus: http://localhost:$${PROMETHEUS_PORT:-9033}"
